<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Keranjang - FoodOrder</title>
        <link rel="stylesheet" href="/css/style.css">
    </head>

    <body>
        <header><h1>Keranjang</h1></header>
        <main>
            <div id="cartItems"></div>
            <div id="cartTotals"></div>

            <h3>Checkout</h3>
            <label>Nomor Meja: <input id="tableNo" type="text"></label>
            <div>
            <label><input type="radio" name="pay" value="cash" checked> Cash</label>
            <label><input type="radio" name="pay" value="debit"> Debit</label>
            <label><input type="radio" name="pay" value="qris"> QRIS (dummy)</label>
            </div>
            <button id="btnCheckout">Checkout</button>
            <button id="btnPrintReceipt" style="display:none;">Cetak Bon</button>
        </main>

        <script>
            async function loadCart() {
            const res = await fetch('/api/cart');
            const data = await res.json();
            const div = document.getElementById('cartItems');
            div.innerHTML = '';
            data.items.forEach(it => {
                const row = document.createElement('div');
                row.className = 'cart-row';
                row.innerHTML = `
                <strong>${it.name}</strong> - Rp ${it.price} x 
                <input type="number" min="0" value="${it.quantity}" data-id="${it.id}" class="qty">
                = Rp ${it.total}
                <button data-id="${it.id}" class="remove">Hapus</button>
                `;
                div.appendChild(row);
            });
            document.getElementById('cartTotals').innerText = `Total: Rp ${data.total.toLocaleString('id-ID')}`;
            document.querySelectorAll('.qty').forEach(input => {
                input.addEventListener('change', async (e) => {
                const id = e.target.dataset.id;
                const quantity = Number(e.target.value);
                await fetch('/api/cart/update', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({id, quantity})
                });
                loadCart();
                });
            });
            document.querySelectorAll('.remove').forEach(b => {
                b.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                await fetch('/api/cart/remove', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({id})
                });
                loadCart();
                });
            });
            }

            document.getElementById('btnCheckout').addEventListener('click', async () => {
            const tableNo = document.getElementById('tableNo').value;
            const pay = document.querySelector('input[name=pay]:checked').value;
            const res = await fetch('/api/checkout', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({paymentMethod: pay, tableNumber: tableNo})
            });
            const j = await res.json();
            if (j.ok) {
                alert('Checkout berhasil!');
                if (pay === 'qris') {
                const win = window.open('', '_blank', 'width=400,height=600');
                win.document.write('<h1>QRIS (Dummy)</h1><p>Scan this placeholder QR</p><img src="/images/qris_dummy.png">');
                }
                const receiptWindow = window.open('', '_blank');
                let html = '<h1>Bon Pembayaran</h1>';
                html += '<ul>';
                const items = j.receipt.items || [];
                for (let it of items) {
                html += `<li>${it.name} x ${it.quantity} = Rp ${it.total}</li>`;
                }
                html += `</ul><p>Total: Rp ${j.receipt.total}</p>`;
                receiptWindow.document.write(html);
                document.getElementById('btnPrintReceipt').style.display = 'inline-block';
                document.getElementById('btnPrintReceipt').onclick = () => receiptWindow.print();
                loadCart();
            } else {
                alert('Checkout gagal: ' + (j.error || 'unknown'));
            }
            });

            loadCart();
        </script>
    </body>
</html>
